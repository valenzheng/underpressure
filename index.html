<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ER Simulation: Nursing Cave 3D</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { overflow: hidden; background-color: #000; }

    /* Cover Screen with Background Image */
    .cover-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-image: url('cover.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      padding-bottom: 10vh;
      z-index: 9999;
    }

    /* Simple Play Button */
    .play-button {
      padding: 1rem 3rem;
      font-size: 2rem;
      font-weight: bold;
      color: white;
      background-color: #ff4444;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .play-button:hover {
      background-color: #ff2222;
      transform: translateY(-2px);
    }

    .play-button:active {
      transform: translateY(1px);
    }

    /* --- HOSPITAL MONITOR LOADING SCREEN --- */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: #000;
      color: #00ff9d; /* Medical green text */
      font-family: 'Courier New', monospace; /* Monitor-style font */
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9998;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease;
    }

    .loading-screen.active {
      opacity: 1;
      pointer-events: all;
    }

    /* Status Messages (Single Line, Typed Effect) */
    .status-container {
      width: 80%;
      max-width: 600px;
      text-align: center;
      border: 1px solid rgba(0, 255, 157, 0.3);
      padding: 2rem;
      border-radius: 5px;
      position: relative; /* Parent container for ECG */
    }

    /* ECG Waveform Container (On Top of Messages) */
    .ecg-container {
      position: absolute;
      top: 5px; /* Moved UP to sit above SYSTEM INITIATING message */
      left: 50%;
      transform: translateX(-50%);
      width: 200px; /* Match ECG's x-range (-2.5 to 2.5 = 5 units → scaled to 200px) */
      height: 50px; /* Vertical space for waveform */
      z-index: 20; /* Higher z-index to ensure it’s above text */
      pointer-events: none; /* Allow clicks through to loading screen if needed */
    }

    .system-init {
      font-size: 1.2rem;
      margin-top: 2rem; /* Add top margin to push text down from ECG */
      margin-bottom: 2rem;
      opacity: 0;
      animation: fade-in 1s forwards;
    }

    .message-line {
      font-size: 1.1rem;
      height: 1.5rem; /* Fixed height to prevent layout shift */
      overflow: hidden;
      position: relative;
    }

    .typed-message {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
      overflow: hidden;
      border-right: 2px solid #00ff9d; /* Typing cursor */
      opacity: 0;
    }

    .typed-message.active {
      opacity: 1;
      animation: typing 1.5s steps(30, end), cursor-blink 0.75s infinite;
    }

    .typed-message.hidden {
      opacity: 0;
      border-right: none;
    }

    .final-message {
      font-size: 1.3rem;
      font-weight: bold;
      color: #ff4444; /* Emergency red for final alert */
      margin-top: 2rem;
      opacity: 0;
      white-space: nowrap;
    }

    .final-message.active {
      animation: fade-in 1s forwards, pulse 1s infinite alternate;
    }

    /* Animations */
    @keyframes fade-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes typing {
      from { width: 0; }
      to { width: 100%; }
    }

    @keyframes cursor-blink {
      from, to { border-color: transparent; }
      50% { border-color: #00ff9d; }
    }

    @keyframes pulse {
      from { opacity: 0.7; }
      to { opacity: 1; }
    }

    /* Game Content (Hidden Initially) */
    #game-content {
      display: none;
    }

    /* Existing Game Styles (Preserved) */
    canvas { display: block; width: 100vw; height: 100vh; cursor: crosshair; }
    .choice-window {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 2rem;
      border-radius: 10px;
      font-family: Arial, sans-serif;
      z-index: 1000;
      max-width: 600px;
      display: none;
    }
    .choice-window h3 { margin-top: 0; color: #ff4444; }
    .choice-window .patient-condition {
      background: rgba(255, 255, 255, 0.1);
      padding: 1rem;
      border-radius: 5px;
      margin-bottom: 1.5rem;
      border-left: 3px solid #ff4444;
    }
    .choice-option {
      padding: 1rem;
      margin: 0.5rem 0;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid #ff4444;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .choice-option:hover { background: rgba(255, 68, 68, 0.3); }
    .hover-tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      font-family: Arial, sans-serif;
      font-size: 0.9rem;
      pointer-events: none;
      z-index: 999;
      display: none;
    }
    .pulse-monitor {
      position: absolute;
      top: 0px;
      right: 20px;
      background: rgba(0, 0, 0, 0.85);
      border: 2px solid #ff4444;
      border-radius: 10px;
      padding: 0.5rem;
      font-family: 'Courier New', monospace;
      color: white;
      z-index: 900;
      min-width: 135px;
      text-align: center;
    }
    .pulse-value {
      font-size: 2.5rem;
      font-weight: bold;
      margin: 10px 0;
      animation: pulse-flash 1s infinite;
    }
    /* Pulse Color Classes */
    .pulse-green { color: #00ff9d; } /* Stable: 100-120 BPM */
    .pulse-yellow { color: #ffff00; } /* Instability: 120-140 BPM or rapidly falling */
    .pulse-red { color: #ff4444; } /* Critical: <80 BPM and dropping */
    .pulse-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    @keyframes pulse-flash {
      0% { opacity: 0.4; transform: scale(0.95); }
      50% { opacity: 1; transform: scale(1.05); }
      100% { opacity: 0.4; transform: scale(0.95); }
    }

    /* Feedback Panel (Replaces Alerts) */
    .feedback-panel {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.95);
      color: white;
      padding: 1.5rem 2rem;
      border-radius: 10px;
      font-family: Arial, sans-serif;
      z-index: 1001;
      max-width: 500px;
      text-align: center;
      display: none;
      border: 2px solid;
    }
    .feedback-correct { border-color: #00ff9d; }
    .feedback-incorrect { border-color: #ff4444; }
    .feedback-panel h4 {
      margin-top: 0;
      margin-bottom: 1rem;
    }
    .feedback-panel p {
      margin-bottom: 1.5rem;
      line-height: 1.5;
    }
    .next-button {
      padding: 0.75rem 2rem;
      font-size: 1rem;
      font-weight: bold;
      color: white;
      background-color: #ff4444;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .next-button:hover {
      background-color: #ff2222;
    }
  </style>
</head>
<body>
  <!-- Cover Screen (Visible on Load) -->
  <div class="cover-screen" id="cover-screen">
    <button class="play-button" id="play-button">Play</button>
  </div>

  <!-- Loading Screen (Hospital Monitor Style) -->
  <div class="loading-screen" id="loading-screen">
    <div class="status-container">
      <!-- ECG Waveform Container (Added Here) -->
      <div class="ecg-container" id="ecg-container"></div>

      <div class="system-init">SYSTEM INITIATING</div>
      <div class="message-line">
        <div class="typed-message" data-text="LOADING ER ENVIRONMENT..." data-delay="1500">LOADING ER ENVIRONMENT...</div>
        <div class="typed-message" data-text="CALIBRATING VITAL SIGN MONITORS..." data-delay="4500">CALIBRATING VITAL SIGN MONITORS...</div>
        <div class="typed-message" data-text="SYNCING PATIENT BIOFEEDBACK DATA..." data-delay="7500">SYNCING PATIENT BIOFEEDBACK DATA...</div>
        <div class="typed-message" data-text="PREPPING TRAUMA BAY..." data-delay="10500">PREPPING TRAUMA BAY...</div>
      </div>
      <div class="final-message" id="final-message">PATIENT ARRIVAL IMMINENT — STANDBY.</div>
    </div>
  </div>

  <!-- Game Content (Hidden Until Load Complete) -->
  <div id="game-content">
    <!-- Pulse Monitor UI -->
    <div class="pulse-monitor">
      <div class="pulse-label">Patient's Pulse (BPM)</div>
      <div class="pulse-value pulse-yellow" id="pulseValue">130</div> <!-- Starts yellow (130 BPM = instability) -->
    </div>

    <!-- Choice Window -->
    <div class="choice-window" id="choiceWindow">
      <h3 id="choicePrompt">Patient Assessment</h3>
      <div class="patient-condition" id="patientCondition">
        <p><strong>Patient: Jordan R., 28</strong></p>
        <p><strong>Mechanism of Injury:</strong> Motorcycle crash</p>
        <p><strong>Current Status:</strong> Pale, cool, clammy skin | Rigid abdomen on palpation</p>
        <p><strong>Vitals:</strong> Pulse <span id="condPulse">130</span> (weak/thready) | BP <span id="condBp">88/60</span> | Respirations <span id="condResp">28</span>/min</p>
        <p><strong>Complaint:</strong> Severe abdominal pain</p>
      </div>
      <div class="choice-options" id="choiceOptions"></div>
    </div>

    <!-- Feedback Panel (Replaces Alerts) -->
    <div class="feedback-panel" id="feedbackPanel">
      <h4 id="feedbackTitle"></h4>
      <p id="feedbackMessage"></p>
      <button class="next-button" id="nextButton">Continue</button>
    </div>

    <!-- Hover Tooltip (Active for First Patient Click) -->
    <div class="hover-tooltip" id="hoverTooltip">Click to assess patient</div>
  </div>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    // ---------------------------
    // ECG WAVEFORM INIT (Integrated)
    // ---------------------------
    let ecgScene, ecgCamera, ecgRenderer;
    let ecgLine, ecgGeometry;
    const numPoints = 100;
    const ecgWave = [
      0, 0, 0, 0,
      0.05, 0.1, 0.15, 0.05, 0,
      -0.15,
      1.3, // R spike
      -0.5,
      0.2, 0.1, 0.05,
      0, 0, 0, 0, 0,
    ];
    let waveIndex = 0;
    let frameCounter = 0;
    const framesPerShift = 2; // Controls ECG speed

    function initECG() {
      const container = document.getElementById('ecg-container');
      
      // Create small orthographic scene for ECG
      ecgScene = new THREE.Scene();
      // Adjust camera to center waveform vertically (better alignment above text)
      ecgCamera = new THREE.OrthographicCamera(-2.5, 2.5, 0.8, -0.2, 0.1, 10); 
      ecgCamera.position.z = 5;

      // Initialize renderer with alpha (transparent background)
      ecgRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      ecgRenderer.setSize(container.clientWidth, container.clientHeight);
      ecgRenderer.setPixelRatio(window.devicePixelRatio);
      container.appendChild(ecgRenderer.domElement);

      // Create ECG line geometry
      const points = [];
      const xStart = -2.5;
      const xEnd = 2.5;
      const xStep = (xEnd - xStart) / (numPoints - 1);

      for (let i = 0; i < numPoints; i++) {
        points.push(new THREE.Vector3(xStart + i * xStep, 0, 0));
      }

      ecgGeometry = new THREE.BufferGeometry().setFromPoints(points);
      const ecgMaterial = new THREE.LineBasicMaterial({ color: 0x00ff00, linewidth: 2 });
      ecgLine = new THREE.Line(ecgGeometry, ecgMaterial);
      ecgLine.scale.y = 0.4; // Slightly reduce scale for better fit
      ecgLine.position.y = 0.1; // Nudge up slightly for perfect alignment
      ecgScene.add(ecgLine);

      // Resize ECG with window
      window.addEventListener('resize', () => {
        ecgRenderer.setSize(container.clientWidth, container.clientHeight);
      });
    }

    // ECG Animation Loop
    function animateECG() {
      requestAnimationFrame(animateECG);

      frameCounter++;
      if (frameCounter < framesPerShift) return;
      frameCounter = 0;

      const pos = ecgGeometry.attributes.position;

      // Shift points left
      for (let i = 0; i < numPoints - 1; i++) {
        pos.setY(i, pos.getY(i + 1));
      }

      // Insert next ECG sample
      pos.setY(numPoints - 1, ecgWave[waveIndex]);
      waveIndex = (waveIndex + 1) % ecgWave.length;

      pos.needsUpdate = true;
      ecgRenderer.render(ecgScene, ecgCamera);
    }

    // DOM Elements for Screens
    const coverScreen = document.getElementById('cover-screen');
    const playButton = document.getElementById('play-button');
    const loadingScreen = document.getElementById('loading-screen');
    const typedMessages = document.querySelectorAll('.typed-message');
    const finalMessage = document.getElementById('final-message');
    const gameContent = document.getElementById('game-content');

    // Play Button Click: Trigger Loading Screen + Start ECG
    playButton.addEventListener('click', () => {
      coverScreen.style.display = 'none';
      loadingScreen.classList.add('active');
      initECG(); // Initialize ECG when loading starts
      animateECG(); // Start ECG animation
      startLoadingSequence();
    });

    // Loading Sequence Logic (Preserved)
    function startLoadingSequence() {
      typedMessages.forEach((message, index) => {
        const delay = parseInt(message.dataset.delay);
        const nextMessage = typedMessages[index + 1];

        setTimeout(() => {
          message.classList.add('active');
          
          setTimeout(() => {
            message.classList.remove('active');
            message.classList.add('hidden');
            
            if (!nextMessage) {
              setTimeout(() => {
                finalMessage.classList.add('active');
                setTimeout(() => {
                  loadingScreen.classList.remove('active');
                  setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    gameContent.style.display = 'block';
                    initGame();
                  }, 500);
                }, 1500);
              }, 500);
            }
          }, 2500);
        }, delay);
      });
    }

    // Game Variables (Updated with Strict Pulse Bounds)
    let scene, camera, renderer, controls, raycaster, mouse;
    let erRoom, patientModel;
    let ambientLight, directionalLight, emergencyLights;
    let vitals = { 
      pulse: 130, // Initial pulse (matches PDF)
      bpSystolic: 88, 
      bpDiastolic: 60, 
      respirations: 28,
      consecutiveWrongAnswers: 0,
      lastPulseChange: Date.now()
    };
    const PULSE_MIN = 60; // Realistic minimum BPM (no lower than this)
    const PULSE_MAX = 220; // Realistic maximum BPM (arrest threshold)
    let gameState = { 
      currentScenario: 1, // 1-10 matching PDF scenarios
      isPatientStable: false,
      lastVitalUpdate: Date.now(),
      vitalDropInterval: 5000,
      ivPenaltyActive: false, // For scenario 5 penalty (faster pulse drop for 2 questions)
      penaltyQuestionCount: 0, // Track questions remaining for IV penalty
      firstQuestionTriggered: false // Track if first question was activated by patient click
    };

    // DOM Elements (Updated with Feedback Panel)
    const choiceWindow = document.getElementById('choiceWindow');
    const choicePrompt = document.getElementById('choicePrompt');
    const patientCondition = document.getElementById('patientCondition');
    const choiceOptions = document.getElementById('choiceOptions');
    const feedbackPanel = document.getElementById('feedbackPanel');
    const feedbackTitle = document.getElementById('feedbackTitle');
    const feedbackMessage = document.getElementById('feedbackMessage');
    const nextButton = document.getElementById('nextButton');
    const hoverTooltip = document.getElementById('hoverTooltip');
    const pulseValueUI = document.getElementById('pulseValue');
    const condPulseUI = document.getElementById('condPulse');
    const condBpUI = document.getElementById('condBp');
    const condRespUI = document.getElementById('condResp');

    // All 10 Scenarios from PDF (Exact Prompts/Options/Correct Answers)
    const scenarios = [
      // Scenario 1: Initial Assessment Window (Triggered by patient click)
      {
        prompt: "What is the FIRST priority intervention?",
        options: [
          { text: "A. Start a full head-to-toe assessment", correct: false, pulseChange: +10 },
          { text: "B. Call for imaging (CT abdomen)", correct: false, pulseChange: +12 },
          { text: "C. Begin rapid IV fluid resuscitation", correct: true, pulseChange: -8 },
          { text: "D. Ask the patient for their medical history", correct: false, pulseChange: +10 }
        ],
        correctFeedback: "Correct! Signs of hypovolemic shock require immediate fluid resuscitation to maintain circulation.",
        incorrectFeedback: "Incorrect. Shock requires immediate fluid resuscitation, not delayed assessment or imaging. Pulse will drop faster.",
        bpChange: { systolic: 0, diastolic: 0 }
      },
      // Scenario 2: Wound/Abdomen Assessment
      {
        prompt: "What is most likely happening internally?",
        options: [
          { text: "A. Pneumothorax", correct: false, pulseChange: +15 },
          { text: "B. Internal hemorrhage", correct: true, pulseChange: -10 },
          { text: "C. Cardiac tamponade", correct: false, pulseChange: +15 },
          { text: "D. Anxiety-induced hyperventilation", correct: false, pulseChange: +12 }
        ],
        correctFeedback: "Correct! Abdominal rigidity, trauma mechanism and shock vitals strongly indicate internal bleeding.",
        incorrectFeedback: "Incorrect. Abdominal trauma with rigid abdomen suggests internal hemorrhage. Heart rate will drop faster over time.",
        bpChange: { systolic: -2, diastolic: -1 }
      },
      // Scenario 3: Shock Recognition
      {
        prompt: "Which type of shock best fits this presentation?",
        options: [
          { text: "A. Hypovolemic shock", correct: true, pulseChange: -7 },
          { text: "B. Cardiogenic shock", correct: false, pulseChange: +10 },
          { text: "C. Septic shock", correct: false, pulseChange: +10 },
          { text: "D. Neurogenic shock", correct: false, pulseChange: +10 }
        ],
        correctFeedback: "Correct! Blood loss causes low blood pressure, rapid pulse and poor tissue perfusion.",
        incorrectFeedback: "Incorrect. This is hypovolemic shock from blood loss. BP will decrease more rapidly.",
        bpChange: { systolic: -3, diastolic: -2 }
      },
      // Scenario 4: Primary Survey Priority
      {
        prompt: "Which assessment framework should guide care RIGHT NOW?",
        options: [
          { text: "A. Head-to-toe assessment", correct: false, pulseChange: +8 },
          { text: "B. ABCs / Primary survey", correct: true, pulseChange: -6 },
          { text: "C. Pain assessment", correct: false, pulseChange: +8 },
          { text: "D. Secondary survey", correct: false, pulseChange: +8 }
        ],
        correctFeedback: "Correct! Life-threatening problems must be addressed before secondary assessments.",
        incorrectFeedback: "Incorrect. Primary survey (ABCs) takes priority in unstable patients. Heart rate will decline gradually.",
        bpChange: { systolic: -2, diastolic: -1 }
      },
      // Scenario 5: Access Decision: IV Supplies
      {
        prompt: "Which IV access is most appropriate RIGHT NOW?",
        options: [
          { text: "A. 24-gauge IV in hand", correct: false, pulseChange: +15 },
          { text: "B. 20-gauge in wrist", correct: false, pulseChange: +12 },
          { text: "C. 18-gauge in antecubital", correct: true, pulseChange: -9 },
          { text: "D. No IV-give oral fluids", correct: false, pulseChange: +20 }
        ],
        correctFeedback: "Correct! Large-bore IV access allows rapid delivery of fluids and blood.",
        incorrectFeedback: "Incorrect. IV too small, fluids infusing too slowly... Pulse will drop faster for the next two questions.",
        bpChange: { systolic: -2, diastolic: -1 },
        penalty: "ivPenalty"
      },
      // Scenario 6: Fluid Choice Judgment
      {
        prompt: "Which fluid is most appropriate initially?",
        options: [
          { text: "A. D5W", correct: false, pulseChange: +10 },
          { text: "B. Normal saline", correct: false, pulseChange: +8 },
          { text: "C. Oral fluids", correct: false, pulseChange: +15 },
          { text: "D. Lactated Ringer’s", correct: true, pulseChange: -7 }
        ],
        correctFeedback: "Correct! Lactated Ringer’s is commonly used to restore volume in trauma patients.",
        incorrectFeedback: "Incorrect. Minimal improvement in vitals, heart rate remains unstable.",
        bpChange: { systolic: +1, diastolic: +1 } // Minimal improvement if wrong
      },
      // Scenario 7: Critical Decision: Blood Transfusion (BP drops to 78/54)
      {
        prompt: "What should a nurse do next?",
        options: [
          { text: "A. Increase fluid rate", correct: false, pulseChange: +18 },
          { text: "B. Prepare for emergency blood transfusion", correct: true, pulseChange: -12 },
          { text: "C. Wait for the doctor to arrive", correct: false, pulseChange: +25 },
          { text: "D. Get a CT scan quickly", correct: false, pulseChange: +22 }
        ],
        correctFeedback: "Correct! Persistent hypotension after fluids indicates ongoing blood loss.",
        incorrectFeedback: "Incorrect. One more wrong answer will cause cardiac arrest.",
        bpChange: { systolic: -10, diastolic: -6 }, // BP drops to 78/54
        critical: true
      },
      // Scenario 8: Blood Timing Concept
      {
        prompt: "When is blood indicated in trauma resuscitation?",
        options: [
          { text: "A. After CT confirms bleeding", correct: false, pulseChange: +15 },
          { text: "B. When BP remains unstable despite fluids", correct: true, pulseChange: -10 },
          { text: "C. Only after labs return", correct: false, pulseChange: +18 },
          { text: "D. When pain is controlled", correct: false, pulseChange: +15 }
        ],
        correctFeedback: "Correct! Blood is required when fluids alone cannot stabilize circulation.",
        incorrectFeedback: "Incorrect. Sudden heart rate drop, patient is in near-failure state.",
        bpChange: { systolic: -5, diastolic: -3 }
      },
      // Scenario 9: Imaging vs Stability Trap
      {
        prompt: "Why is CT imaging NOT the priority right now?",
        options: [
          { text: "A. CT takes too long to schedule", correct: false, pulseChange: +12 },
          { text: "B. Imaging worsens bleeding", correct: false, pulseChange: +12 },
          { text: "C. The patient is hemodynamically unstable", correct: true, pulseChange: -8 },
          { text: "D. CT is only for fractures", correct: false, pulseChange: +15 }
        ],
        correctFeedback: "Correct! Unstable patients must be stabilized before imaging.",
        incorrectFeedback: "Incorrect. Heart rhythm becomes irregular, one final chance remains.",
        bpChange: { systolic: -5, diastolic: -3 }
      },
      // Scenario 10: Final Pressure Moment
      {
        prompt: "What is your PRIORITY action?",
        options: [
          { text: "A. Comfort the patient", correct: false, pulseChange: +30 },
          { text: "B. Document findings", correct: false, pulseChange: +35 },
          { text: "C. Reassess temperature", correct: false, pulseChange: +30 },
          { text: "D. Notify trauma team-suspected internal hemorrhage", correct: true, pulseChange: -15 },
        ],
        correctFeedback: "Correct! Rapid escalation ensures immediate surgical intervention.",
        incorrectFeedback: "Incorrect. Fatal delay, cardiac arrest occurs.",
        bpChange: { systolic: -10, diastolic: -5 },
        final: true
      }
    ];

    // Initialize Game
    function initGame() {
      initBoilerplate();
      loadAssets();
      animate();
    }

    // Game Setup (Updated with Patient Click Trigger)
    function initBoilerplate() {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 10000);
      camera.position.set(0, 2, -2); // Original camera position (not zoomed)

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      document.body.appendChild(renderer.domElement);

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.08;
      controls.minDistance = 0.5;
      controls.maxDistance = 8;
      controls.maxPolarAngle = Math.PI / 2 - 0.1;
      controls.target.set(1.75, 0.75, 1.3);

      raycaster = new THREE.Raycaster();
      mouse = new THREE.Vector2();
      window.addEventListener('mousemove', (e) => {
        mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
        hoverTooltip.style.left = `${e.clientX + 10}px`;
        hoverTooltip.style.top = `${e.clientY - 20}px`;
      });
      window.addEventListener('click', handleMouseClick);

      // Lighting
      ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
      directionalLight = new THREE.DirectionalLight(0xffffdd, 1.5);
      directionalLight.position.set(5, 8, 3);
      emergencyLights = new THREE.PointLight(0xff4444, 0.3, 10);
      emergencyLights.position.set(2, 3, 2);
      scene.add(ambientLight, directionalLight, emergencyLights);

      window.addEventListener('resize', onWindowResize);

      // Next Button Click: Progress to Next Scenario (Automatic after first question)
      nextButton.addEventListener('click', () => {
        feedbackPanel.style.display = 'none';
        gameState.currentScenario++;
        
        // Check if all scenarios are completed
        if (gameState.currentScenario > scenarios.length) {
          endSimulation(true);
          return;
        }

        // Show next scenario AUTOMATICALLY (no more clicks needed)
        showScenario(gameState.currentScenario - 1);
      });
    }

    // Load 3D Assets
    function loadAssets() {
      const loader = new GLTFLoader();
      loader.load('er_room.glb', (gltf) => {
        erRoom = gltf.scene;
        erRoom.scale.set(1, 1, 1);
        erRoom.position.y = 0;
        scene.add(erRoom);
        loadPatient();
      }, (xhr) => console.log(`ER Room: ${(xhr.loaded/xhr.total*100).toFixed(1)}%`), 
      (error) => alert('Failed to load er_room.glb'));
    }

    function loadPatient() {
      const loader = new GLTFLoader();
      loader.load('patient.glb', (gltf) => {
        patientModel = gltf.scene;
        patientModel.scale.set(0.022, 0.022, 0.022);
        patientModel.position.set(1.75, 0.75, 1.3);
        patientModel.rotation.y = Math.PI;
        scene.add(patientModel);
        controls.target.copy(patientModel.position);
        startGame();
      }, (xhr) => console.log(`Patient: ${(xhr.loaded/xhr.total*100).toFixed(1)}%`),
      (error) => alert('Failed to load patient.glb'));
    }

    // Start Game: Wait for Patient Click to Trigger First Question
    function startGame() {
      console.log('Game started! Click patient to begin assessment.');
      gameState.lastVitalUpdate = Date.now();
      updateVitalUI();
      // No automatic scenario - wait for patient click
    }

    // Handle Patient Click (Triggers First Question)
    function handleMouseClick() {
      if (!patientModel || gameState.firstQuestionTriggered || gameState.isZooming) return;
      
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObject(patientModel, true);
      
      if (intersects.length > 0) {
        gameState.firstQuestionTriggered = true;
        hoverTooltip.style.display = 'none'; // Hide tooltip after first click
        
        // Zoom to patient for better immersion
        zoomToPatient(() => {
          showScenario(0); // Show first scenario (index 0) after zoom
        });
      }
    }

    // Check for Patient Hover (Show Tooltip Before First Click)
    function checkPatientHover() {
      if (!patientModel || gameState.firstQuestionTriggered || gameState.isZooming || choiceWindow.style.display === 'block') {
        hoverTooltip.style.display = 'none';
        return;
      }
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObject(patientModel, true);
      hoverTooltip.style.display = intersects.length > 0 ? 'block' : 'none';
    }

    // Zoom to Patient with Callback
    function zoomToPatient(callback) {
      gameState.isZooming = true;
      controls.enabled = false;
      const duration = 1000;
      const startTime = Date.now();
      const originalPos = camera.position.clone();
      const targetPos = new THREE.Vector3(0.5, 1.2, 0.8);

      function animateZoom() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed/duration, 1);
        const easeProgress = easeInOutCubic(progress);
        camera.position.lerpVectors(originalPos, targetPos, easeProgress);
        
        if (progress < 1) {
          requestAnimationFrame(animateZoom);
        } else {
          gameState.isZooming = false;
          controls.enabled = true;
          if (callback) callback();
        }
      }
      animateZoom();
    }

    function easeInOutCubic(t) {
      return t < 0.5 ? 4*t*t*t : 1 - Math.pow(-2*t + 2, 3)/2;
    }

    // Show Specific Scenario
    function showScenario(index) {
      const scenario = scenarios[index];
      choicePrompt.textContent = scenario.prompt;
      choiceOptions.innerHTML = '';

      // Update BP per scenario (e.g., scenario 7 drops to 78/54)
      vitals.bpSystolic = Math.max(60, vitals.bpSystolic + scenario.bpChange.systolic);
      vitals.bpDiastolic = Math.max(40, vitals.bpDiastolic + scenario.bpChange.diastolic);

      // Create answer options
      scenario.options.forEach((option) => {
        const div = document.createElement('div');
        div.className = 'choice-option';
        div.textContent = option.text;
        div.addEventListener('click', () => handleAnswer(index, option.correct, option.pulseChange));
        choiceOptions.appendChild(div);
      });

      updateVitalUI();
      choiceWindow.style.display = 'block';
    }

    // Handle Answer Submission (Fixed Pulse Bounds)
    function handleAnswer(scenarioIndex, isCorrect, pulseChange) {
      const scenario = scenarios[scenarioIndex];
      choiceWindow.style.display = 'none';

      // Apply IV penalty (faster pulse drop for 2 questions)
      if (gameState.ivPenaltyActive) {
        pulseChange *= 1.5; // 50% faster pulse drop
        gameState.penaltyQuestionCount++;
        
        // Reset penalty after 2 questions
        if (gameState.penaltyQuestionCount >= 2) {
          gameState.ivPenaltyActive = false;
          gameState.penaltyQuestionCount = 0;
        }
      }

      // Update Pulse with STRICT bounds (no <60 or >220)
      if (isCorrect) {
        // Correct answer: decrease pulse but not below minimum
        vitals.pulse = Math.max(PULSE_MIN, vitals.pulse + pulseChange);
        vitals.consecutiveWrongAnswers = 0;
        feedbackTitle.textContent = "CORRECT";
        feedbackTitle.style.color = "#00ff9d";
        feedbackMessage.textContent = scenario.correctFeedback;
        feedbackPanel.className = "feedback-panel feedback-correct";
      } else {
        // Wrong answer: increase pulse but not above maximum
        vitals.pulse = Math.min(PULSE_MAX, vitals.pulse + pulseChange);
        vitals.consecutiveWrongAnswers++;
        
        // Special handling for critical scenarios
        if (scenario.critical && vitals.consecutiveWrongAnswers >= 2) {
          endSimulation(false);
          return;
        }
        
        // Fatal error for final scenario
        if (scenario.final) {
          endSimulation(false);
          return;
        }

        feedbackTitle.textContent = "INCORRECT";
        feedbackTitle.style.color = "#ff4444";
        feedbackMessage.textContent = scenario.incorrectFeedback;
        feedbackPanel.className = "feedback-panel feedback-incorrect";

        // Apply IV penalty if scenario 5 is wrong
        if (scenario.penalty === "ivPenalty") {
          gameState.ivPenaltyActive = true;
          gameState.penaltyQuestionCount = 0;
        }
      }

      // Update UI and show feedback
      updateVitalUI();
      feedbackPanel.style.display = 'block';

      // Check for cardiac arrest (pulse at max/min bounds)
      if (vitals.pulse === PULSE_MAX || vitals.pulse === PULSE_MIN) {
        endSimulation(false);
      }
    }

    // Update Vital Signs UI + Pulse Color (Fixed Display)
    function updateVitalUI() {
      // Ensure pulse is an integer (no decimals) and within bounds
      const displayPulse = Math.round(vitals.pulse);
      
      // Update values
      pulseValueUI.textContent = displayPulse;
      condPulseUI.textContent = displayPulse;
      condBpUI.textContent = `${vitals.bpSystolic}/${vitals.bpDiastolic}`;
      condRespUI.textContent = vitals.respirations;
      
      // Update pulse animation speed
      const animationSpeed = 60 / displayPulse;
      pulseValueUI.style.animationDuration = `${animationSpeed}s`;

      // Update pulse color (Green/Yellow/Red based on BPM ranges)
      pulseValueUI.classList.remove('pulse-green', 'pulse-yellow', 'pulse-red');
      if (displayPulse >= 100 && displayPulse <= 120) {
        pulseValueUI.classList.add('pulse-green'); // Stable
      } else if ((displayPulse > 120 && displayPulse <= 140) || (displayPulse < 100 && displayPulse >= 80)) {
        pulseValueUI.classList.add('pulse-yellow'); // Instability
      } else {
        pulseValueUI.classList.add('pulse-red'); // Critical (<80 or >140)
      }

      vitals.lastPulseChange = Date.now();
    }

    // Gradual Vital Deterioration (Fixed Pulse Bounds)
    function updateVitals() {
      const now = Date.now();
      const interval = gameState.ivPenaltyActive ? gameState.vitalDropInterval / 2 : gameState.vitalDropInterval;

      if (now - gameState.lastVitalUpdate > interval) {
        // Pulse increases (deteriorates) but stays within bounds
        const pulseDrop = gameState.ivPenaltyActive ? 5 : 3;
        vitals.pulse = Math.min(PULSE_MAX, vitals.pulse + pulseDrop);
        
        // BP and respirations with bounds
        vitals.bpSystolic = Math.max(60, vitals.bpSystolic - 2);
        vitals.bpDiastolic = Math.max(40, vitals.bpDiastolic - 1);
        vitals.respirations = Math.min(40, vitals.respirations + 1);

        updateVitalUI();
        console.log('Vitals worsened | Pulse:', vitals.pulse);

        // Check for cardiac arrest (pulse at max/min)
        if (vitals.pulse === PULSE_MAX || vitals.pulse === PULSE_MIN) {
          endSimulation(false);
        }

        gameState.lastVitalUpdate = now;
      }
    }

    // End Simulation (Success/Failure)
    function endSimulation(isSuccess) {
      choiceWindow.style.display = 'none';
      feedbackPanel.style.display = 'none';

      // Create end screen overlay matching PDF requirements
      const endScreen = document.createElement('div');
      endScreen.style.position = 'fixed';
      endScreen.style.top = '0';
      endScreen.style.left = '0';
      endScreen.style.width = '100vw';
      endScreen.style.height = '100vh';
      endScreen.style.backgroundColor = isSuccess ? 'rgba(0, 0, 0, 0.9)' : 'rgba(0, 0, 0, 0.95)';
      endScreen.style.display = 'flex';
      endScreen.style.flexDirection = 'column';
      endScreen.style.justifyContent = 'center';
      endScreen.style.alignItems = 'center';
      endScreen.style.zIndex = '9999';
      endScreen.style.color = 'white';
      endScreen.style.fontFamily = 'Arial, sans-serif';
      endScreen.style.textAlign = 'center';
      endScreen.style.padding = '2rem';
      endScreen.style.animation = isSuccess ? 'none' : 'fadeToBlack 2s forwards';

      // Success/Failure Styling
      if (isSuccess) {
        // Success: Scene freezes, alarms soften
        endScreen.style.background = 'rgba(0, 0, 0, 0.7)';
      } else {
        // Failure: Fade to black, flatline tone implied
        endScreen.style.background = 'black';
      }

      const endTitle = document.createElement('h2');
      endTitle.style.fontSize = '2.5rem';
      endTitle.style.marginBottom = '1.5rem';
      endTitle.style.color = isSuccess ? '#00ff9d' : '#ff4444';
      endTitle.textContent = isSuccess ? 'SUCCESS' : 'FAILURE';

      const endMessage = document.createElement('p');
      endMessage.style.fontSize = '1.2rem';
      endMessage.style.maxWidth = '600px';
      endMessage.style.lineHeight = '1.6';
      endMessage.textContent = isSuccess 
        ? "Correct prioritization under pressure prevented cardiac arrest."
        : "Delayed or incorrect decisions resulted in patient death.";

      const restartButton = document.createElement('button');
      restartButton.style.marginTop = '2rem';
      restartButton.style.padding = '1rem 3rem';
      restartButton.style.fontSize = '1.2rem';
      restartButton.style.fontWeight = 'bold';
      restartButton.style.color = 'white';
      restartButton.style.backgroundColor = '#ff4444';
      restartButton.style.border = 'none';
      restartButton.style.borderRadius = '5px';
      restartButton.style.cursor = 'pointer';
      restartButton.textContent = 'Play Again';
      restartButton.addEventListener('click', () => location.reload());

      endScreen.appendChild(endTitle);
      endScreen.appendChild(endMessage);
      endScreen.appendChild(restartButton);
      document.body.appendChild(endScreen);
    }

    // Fade to black animation for failure
    const style = document.createElement('style');
    style.textContent = `
      @keyframes fadeToBlack {
        from { background: rgba(0, 0, 0, 0.5); }
        to { background: #000; }
      }
    `;
    document.head.appendChild(style);

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      emergencyLights.intensity = 0.3 + Math.sin(Date.now()*0.001)*0.1;
      updateVitals();
      checkPatientHover();
      renderer.render(scene, camera);
    }
  </script>
</body>
</html>
